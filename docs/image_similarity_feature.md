# 图片相似度删除功能

## 功能概述

新增的图片相似度删除功能可以帮助用户自动识别和删除相似的图片，支持两种处理模式：

1. **跨文件夹比较模式**：平衡各文件夹的图片数量
2. **文件夹内比较模式**：删除每个文件夹内的重复图片

## 功能特点

- 使用感知哈希算法（pHash）进行图片相似度计算
- 支持多种图片格式：JPG、JPEG、PNG、BMP、GIF、TIFF
- 可调节相似度阈值（0.1-1.0）
- 实时进度显示和日志记录
- 支持取消操作
- 智能删除策略

## 使用方法

### 1. 启动应用

```bash
.venv\Scripts\python.exe -m src.one_dragon_yolo.gui.app
```

### 2. 选择"相似度删除"标签页

在应用主界面中，点击"相似度删除"标签页。

### 3. 配置参数

- **选择根文件夹**：选择包含子文件夹的根目录
- **相似度阈值**：设置相似度阈值（0.1-1.0），越高越严格
- **处理模式**：选择处理模式

### 4. 开始处理

点击"开始处理"按钮，系统将自动处理图片。

## 处理模式详解

### 跨文件夹比较模式

**目标**：平衡各文件夹的图片数量

**工作原理**：
1. 按图片数量对文件夹排序（从少到多）
2. 从图片数量最少的文件夹开始
3. 与其他文件夹进行比较
4. 删除其他文件夹中的相似图片
5. 保留图片数量少的文件夹中的图片

**适用场景**：
- 数据集平衡
- 不同类别的图片数量差异较大
- 希望保持各类别图片数量相对均衡

**示例**：
```
处理前：
├── cats/     (3张图片)
├── dogs/     (8张图片)
└── birds/    (5张图片)

处理后：
├── cats/     (3张图片) ← 保留所有
├── dogs/     (5张图片) ← 删除了3张相似的
└── birds/    (4张图片) ← 删除了1张相似的
```

### 文件夹内比较模式

**目标**：删除每个文件夹内的重复图片

**工作原理**：
1. 遍历每个子文件夹
2. 在文件夹内部进行图片相似度比较
3. 删除相似的图片（保留文件名较短的）

**适用场景**：
- 清理重复图片
- 减少存储空间
- 去除同一类别内的冗余数据

**示例**：
```
处理前：
└── animals/
    ├── cat1.jpg
    ├── cat1_copy.jpg     ← 与cat1.jpg相似
    ├── dog1.jpg
    ├── dog1_duplicate.jpg ← 与dog1.jpg相似
    └── bird1.jpg

处理后：
└── animals/
    ├── cat1.jpg          ← 保留
    ├── dog1.jpg          ← 保留
    └── bird1.jpg         ← 保留
```

## 相似度阈值说明

相似度阈值决定了两张图片被认为是"相似"的标准：

- **0.9-1.0**：非常严格，只删除几乎完全相同的图片
- **0.8-0.9**：严格，删除高度相似的图片
- **0.7-0.8**：中等，删除明显相似的图片
- **0.6-0.7**：宽松，删除有一定相似性的图片
- **0.1-0.6**：非常宽松，可能删除不太相似的图片

**建议设置**：
- 首次使用：0.85
- 严格去重：0.9
- 宽松去重：0.75

## 技术实现

### 核心算法

使用感知哈希（Perceptual Hash）算法：
1. 将图片缩放到固定大小
2. 转换为灰度图
3. 计算离散余弦变换（DCT）
4. 提取低频信息生成哈希值
5. 通过汉明距离计算相似度

### 文件结构

```
src/one_dragon_yolo/
├── gui/
│   ├── app.py                    # 主应用（已修改）
│   └── image_similarity_tab.py   # 相似度删除标签页
└── image_modules/
    └── similarity_processor.py   # 相似度处理核心模块
```

### 主要类

- `ImageSimilarityProcessor`：核心处理器
- `ImageSimilarityWorker`：后台工作线程
- `ImageSimilarityTab`：用户界面

## 注意事项

1. **备份重要数据**：处理前请备份重要图片，删除操作不可逆
2. **处理时间**：大量图片的处理可能需要较长时间
3. **内存使用**：处理大量图片时会占用较多内存
4. **文件权限**：确保对目标文件夹有读写权限

## 故障排除

### 常见问题

1. **"需要至少2个子文件夹"错误**
   - 确保选择的根文件夹包含至少2个子文件夹

2. **"无法处理图片"警告**
   - 检查图片文件是否损坏
   - 确认图片格式是否支持

3. **处理速度慢**
   - 减少图片数量
   - 降低相似度阈值
   - 关闭其他占用内存的程序

4. **删除文件失败**
   - 检查文件权限
   - 确认文件未被其他程序占用

### 性能优化建议

1. **分批处理**：对于大量图片，建议分批处理
2. **预筛选**：先手动删除明显不需要的图片
3. **调整阈值**：根据实际需求调整相似度阈值

## 测试

项目包含完整的测试脚本：

```bash
.venv\Scripts\python.exe test_similarity.py
```

测试脚本会自动创建测试图片并验证两种处理模式的功能。
